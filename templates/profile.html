{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<div class="profile-body container-fluid">
    <div class="profile-header d-flex justify-content-between align-items-center mb-4 pt-3">
      <h1 class="mb-0 suse-mono-title text-start" style="font-size: 2.5rem;">Profile Settings</h1>
      <button type="button" class="edit-btn btn btn-primary" id="editProfileBtn">Edit your profile</button>
    </div>

    <div class="edit-profile mw-100" style="max-width: 800px;">
      <input type="hidden" id="userId" value="{{ session.get('user_id', '') }}">

      <div class="mb-3 name">
        <label for="InputName" class="form-label fw-bold">Full name</label>
        <input type="text" class="form-control" id="InputName" value="{{ user or 'N/A' }}" placeholder="Your full name" readonly>
      </div>

      <div class="mb-3 username">
        <label for="InputUsername" class="form-label fw-bold">Username</label>
        <input type="text" class="form-control" id="InputUsername" value="{{ session.get('username', 'N/A') }}" placeholder="Your username" readonly>
      </div>

      <div class="mb-3 email">
        <label for="InputEmail" class="form-label fw-bold">Email address</label>
        <input type="text" class="form-control" id="InputEmail" value="{{ session.get('email', 'N/A') }}" placeholder="Your email address" readonly>
      </div>

      <div class="mb-3 password p-3 border rounded bg-light" id="passwordSection" style="display: none; flex-direction: column; gap: 1rem;">
        <h5 class="mb-2">Change Password</h5>
        <div>
          <label for="currentPassword" class="form-label">Current password</label>
          <input type="password" class="form-control" id="currentPassword">
        </div>
        <div>
          <label for="newPassword" class="form-label">New password</label>
          <input type="password" class="form-control" id="newPassword">
        </div>
        <div>
          <label for="confirmNewPassword" class="form-label">Confirm new password</label>
          <input type="password" class="form-control" id="confirmNewPassword">
        </div>
      </div>

      <div class="form-footer mt-4 gap-2" id="formFooter" style="display: none;">
        <button type="button" class="cancel-btn btn btn-secondary">Cancel</button>
        <button type="button" class="save-changes-btn btn btn-primary">Save changes</button>
      </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title w-100" id="alertModalTitle">Success</h5>
      </div>
      <div class="modal-body" id="alertModalBody">Profile updated successfully!</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/edit_account.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editBtn = document.getElementById("editProfileBtn");
  const passwordSection = document.getElementById("passwordSection");
  const formFooter = document.getElementById("formFooter");
  const cancelBtn = document.querySelector(".cancel-btn");
  const saveBtn = document.querySelector(".save-changes-btn");
  const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
  const alertModalTitle = document.getElementById("alertModalTitle");
  const alertModalBody = document.getElementById("alertModalBody");
  const inputs = document.querySelectorAll(".edit-profile input:not([type='hidden'])");

  const userId = document.getElementById("userId").value; // Current user ID

  // Initially hide footer buttons
  formFooter.style.display = "none";

  // Enable editing
  editBtn.addEventListener("click", () => {
    inputs.forEach(i => i.removeAttribute("readonly"));
    passwordSection.style.display = "flex";
    formFooter.style.display = "flex";
    editBtn.style.display = "none";
  });

  // Cancel editing
  cancelBtn.addEventListener("click", () => {
    location.reload();
  });

  // Save changes
  saveBtn.addEventListener("click", async () => {
    const name = document.getElementById("InputName").value.trim();
    const username = document.getElementById("InputUsername").value.trim();
    const email = document.getElementById("InputEmail").value.trim();
    const currentPass = document.getElementById("currentPassword").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();
    const confirmPass = document.getElementById("confirmNewPassword").value.trim();

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && !emailRegex.test(email)) {
      showModal("Error", "Please enter a valid email format.");
      return;
    }

    // Password validation if user wants to change
    if (currentPass || newPass || confirmPass) {
      if (!currentPass || !newPass || !confirmPass) {
        showModal("Error", "Please fill in all password fields to change your password.");
        return;
      }
      if (newPass !== confirmPass) {
        showModal("Error", "New password and confirmation do not match.");
        return;
      }
    }

    // Prepare payload
    const payload = { nameOfUser: name, username, email };
    if (newPass) payload.password = newPass;

    try {
      const response = await fetch(`/edit_account/${userId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json();

      if (data.success) {
        showModal("Success", "Profile updated successfully!");
        inputs.forEach(i => i.setAttribute("readonly", true));
        passwordSection.style.display = "none";
        formFooter.style.display = "none";
        editBtn.style.display = "block";
      } else {
        showModal("Error", data.message || "Failed to update profile.");
      }
    } catch (error) {
      console.error("Error updating profile:", error);
      showModal("Error", "An error occurred while updating your profile.");
    }
  });

  function showModal(title, message) {
    alertModalTitle.textContent = title;
    alertModalBody.textContent = message;
    alertModal.show();
  }
});
</script>
{% endblock %}